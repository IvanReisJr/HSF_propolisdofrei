===========================================================
PROJETO: HSF_propolisdofrei - DOCUMENTAÇÃO COMPLETA
===========================================================
Data de Atualização: 04/02/2026

1. INTEGRAÇÃO COM N8N (Workflow de Dados)
-----------------------------------------------------------
O n8n atua como a camada de "orquestração" fora do Django.
- Função no Projeto: Conectar o banco Oracle/PostgreSQL ao Django e WhatsApp.
- Benefícios: 
    * Redução de carga no servidor Django (processamento em background).
    * Facilidade para criar Dashboards rápidos sem codar novas views.
    * Webhooks: O Django avisa o n8n quando um estoque está baixo, e o n8n envia o alerta.

2. AUTOMAÇÃO DE SENHAS E SEGURANÇA
-----------------------------------------------------------
- Objetivo: Reduzir suporte técnico manual.
- Fluxo:
    1. Usuário solicita reset via formulário ou bot.
    2. Django valida a identidade (e-mail + Unidade Distribuidora).
    3. Python script (ou n8n) gera token temporário e dispara via WAHA (WhatsApp).
- Regra de Ouro: Nunca armazenar senhas em texto plano; usar o hasher padrão do Django.

3. POR QUE O N8N AGREGA VALOR?
-----------------------------------------------------------
- Flexibilidade: Se você precisar mudar o envio de E-mail para WhatsApp, muda no n8n em 1 minuto, sem mexer no código Python do Django.
- Escalabilidade: O n8n pode rodar em um container Docker separado, mantendo o Django leve apenas para as regras de negócio.
- Conectividade: Facilita a leitura de XMLs e integração com o sistema Tasy (Philips) que você já utiliza.

4. PROTOCOLO DE TESTE GUARD (REVISÃO)
-----------------------------------------------------------
- Toda nova rota de API criada para o n8n deve ser protegida por Token.
- O teste 'test_seguranca_multitenancy' deve cobrir as rotas que o n8n consome.

===========================================================

5. BLINDAGEM E SEGURANÇA (IMPLEMENTAÇÃO FEV/2026)
-----------------------------------------------------------
Implementação do isolamento lógico entre Matriz e Filiais/Distribuidores.

5.1. Isolamento de Dados (Multi-Tenancy Lógico)
- O modelo `Packaging` (Embalagem) e `ProductStock` (Estoque) agora possuem vínculo direto com `Distributor`.
- Regra de Ouro: Usuários comuns só enxergam dados onde `distributor__id == request.user.distributor.id`.
- Apenas Superusuários (Admin) ou Staff (Matriz) podem ver dados globais, dependendo da View.

5.2. Inativação Segura (Soft Delete)
- Modelos `UnitOfMeasure`, `Distributor`, `Category`, `Packaging` e `Product` usam `is_active=True/False`.
- NENHUM dado é deletado fisicamente do banco.
- Views de Inativação:
    * Unidades: Apenas Staff (Matriz).
    * Distribuidores: Apenas Superusuários.
    * Produtos/Embalagens: Restrito à unidade do usuário.

5.3. Controle de Acesso (Login)
- Signal `user_logged_in` implementado: Se `Distributor.is_active` for False, todos os usuários vinculados são desconectados imediatamente.

5.4. Estoque e Torre de Controle
- Entrada de Estoque (`registrar_entrada`): Usa `transaction.atomic` para separar movimentações por unidade e garantir integridade.
- Dashboard (`dashboard_matriz_consolidado`): View exclusiva da Matriz que consolida saldos de todas as filiais para tomada de decisão.

===========================================================