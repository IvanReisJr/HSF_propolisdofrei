{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Própolis do Frei - Sistema de Gestão{% endblock %}</title>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Tailwind CSS (Optional - for utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    {% block extra_head %}
    <style>
        @keyframes pulse-blue {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .pulse-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .pulse-blue {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #3b82f6;
            /* blue-500 */
            border-radius: 9999px;
            animation: pulse-blue 2s infinite;
            z-index: -1;
        }

        .card-movimentacoes {
            cursor: pointer;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9998;
            /* Abaixo do modal */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            display: none;
            /* Começa oculto */
        }

        .modal-backdrop.active {
            display: block;
            opacity: 1;
        }

        .modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            z-index: 9999;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 90%;
            max-width: 48rem;
            max-height: 90vh;
            display: none;
            /* Começa oculto */
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }

        .modal-container.active {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-body {
            overflow-y: auto;
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .skeleton-loader {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f0f0f0 8%, #e0e0e0 18%, #f0f0f0 33%);
            background-size: 2000px 100%;
            border-radius: 4px;
        }

        .sidebar-fixo {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            /* Ajuste de scroll fino para o menu se houver muitos itens */
        }

        .sidebar-fixo::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-fixo::-webkit-scrollbar-thumb {
            background: #4B3621;
        }

        .nav-link,
        .nav-sublink {
            font-size: 0.85rem !important;
            /* Diminui levemente a fonte */
            white-space: nowrap !important;
            /* Impede que o texto pule para a linha de baixo */
            overflow: hidden;
            text-overflow: ellipsis;
            /* Caso o nome seja muito longo, ele coloca "..." no final em vez de quebrar */
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
            gap: 0.5rem !important;
            /* Diminui o espaço entre o ícone e o texto */
        }

        .nav-link.active,
        .nav-sublink.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        @media (max-height: 768px) {

            .nav-link,
            .nav-sublink {
                padding-top: 0.35rem !important;
                padding-bottom: 0.35rem !important;
            }

            .nav-section-toggle {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
        }
    </style>
    {% endblock %}
    <style>
        /* HTMX Progress Bar */
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: inline;
        }

        .htmx-request.htmx-indicator {
            display: inline;
        }

        /* Top progress bar */
        #progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background-color: var(--primary);
            z-index: 9999;
            transition: width 0.3s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>

<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    {% include "includes/debug_toolbar.html" %}
    <div id="progress-bar"></div>
    <div class="app-container">
        {% if user.is_authenticated %}
        <!-- Sidebar -->
        <aside class="sidebar sidebar-fixo">
            <div class="sidebar-header" style="padding: 1.5rem 1rem; justify-content: center;">
                <img src="{% static 'img/DoFrei.png' %}" alt="Própolis do Frei" class="sidebar-logo">
            </div>
            <nav class="sidebar-content" hx-target="#content-area" hx-push-url="true" hx-boost="true">
                <a href="/" class="nav-link {% if request.path   ==   '/' %}active{% endif %}">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>

                {% if user.is_superuser or user.distributor.tipo_unidade == 'MATRIZ' %}
                <!-- Cadastros Collapsible Section -->
                <div class="nav-section" style="margin-top: 0.5rem;">
                    <button class="nav-section-toggle" onclick="toggleSection('cadastros')"
                        style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 2px; color: #F3E5AB; font-weight: 600; background: none; border: none; width: 100%; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                        <i data-lucide="folder-open"></i>
                        <span>Gestão / Cadastros</span>
                        <i data-lucide="chevron-down" class="chevron" id="cadastros-chevron"
                            style="margin-left: auto; transition: transform 0.3s ease; width: 16px; height: 16px;"></i>
                    </button>
                    <div class="nav-submenu" id="cadastros-submenu"
                        style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 1rem;">
                        <a href="{% url 'product_list' %}"
                            class="nav-sublink {% if 'products' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="package" style="width: 16px; height: 16px;"></i> Produtos
                        </a>
                        <a href="{% url 'packaging_list' %}"
                            class="nav-sublink {% if 'packagings' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="box" style="width: 16px; height: 16px;"></i> Embalagens
                        </a>
                        <a href="/categories/"
                            class="nav-sublink {% if 'categories' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="folder" style="width: 16px; height: 16px;"></i> Categorias
                        </a>
                        <a href="/core/units/"
                            class="nav-sublink {% if 'core/units' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="scale" style="width: 16px; height: 16px;"></i> Unidades de Medida
                        </a>
                        <a href="{% url 'distributor_list' %}"
                            class="nav-sublink {% if 'distributors' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="building-2" style="width: 16px; height: 16px;"></i> Gestão de Unidades
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Operação Collapsible Section -->
                <div class="nav-section" style="margin-top: 0.5rem;">
                    <button class="nav-section-toggle" onclick="toggleSection('operacao')"
                        style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 2px; color: #F3E5AB; font-weight: 600; background: none; border: none; width: 100%; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                        <i data-lucide="activity"></i>
                        <span>Operação</span>
                        <i data-lucide="chevron-down" class="chevron" id="operacao-chevron"
                            style="margin-left: auto; transition: transform 0.3s ease; width: 16px; height: 16px;"></i>
                    </button>
                    <div class="nav-submenu" id="operacao-submenu"
                        style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 1rem;">
                        <a href="/stock/movements/"
                            class="nav-sublink {% if 'stock' in request.path and 'movements' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="arrow-left-right" style="width: 16px; height: 16px;"></i> Estoque
                        </a>
                        <a href="{% url 'inventory_report' %}"
                            class="nav-sublink {% if 'reports/inventory' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="clipboard-list" style="width: 16px; height: 16px;"></i> Rel. de Inventário
                        </a>
                        <a href="/orders/" class="nav-sublink {% if 'orders' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="shopping-cart" style="width: 16px; height: 16px;"></i> Pedidos
                        </a>
                        <a href="{% url 'settlement_list' %}"
                            class="nav-sublink {% if 'financeiro' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="dollar-sign" style="width: 16px; height: 16px;"></i> Prestação de Contas
                            {% if pending_payments_count and pending_payments_count > 0 %}
                            <span
                                style="background-color: #f59e0b; color: white; border-radius: 9999px; padding: 0.125rem 0.375rem; font-size: 0.75rem; font-weight: 700; margin-left: auto;">
                                {{ pending_payments_count }}
                            </span>
                            {% endif %}
                        </a>
                    </div>
                </div>

                {% if user.is_superuser or user.distributor.tipo_unidade == 'MATRIZ' %}
                <!-- Administração Collapsible Section -->
                <div class="nav-section" style="margin-top: 0.5rem;">
                    <button class="nav-section-toggle" onclick="toggleSection('administracao')"
                        style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 2px; color: #F3E5AB; font-weight: 600; background: none; border: none; width: 100%; cursor: pointer; font-size: 0.875rem; transition: all 0.2s;">
                        <i data-lucide="shield"></i>
                        <span>Administração</span>
                        <i data-lucide="chevron-down" class="chevron" id="administracao-chevron"
                            style="margin-left: auto; transition: transform 0.3s ease; width: 16px; height: 16px;"></i>
                    </button>
                    <div class="nav-submenu" id="administracao-submenu"
                        style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease; padding-left: 1rem;">
                        <a href="/admin/" class="nav-sublink" hx-boost="false"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="settings" style="width: 16px; height: 16px;"></i> Django Admin
                        </a>
                        <a href="{% url 'financial_audit_list' %}"
                            class="nav-sublink {% if 'matriz/auditoria' in request.path %}active{% endif %}"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="clipboard-list" style="width: 16px; height: 16px;"></i> Auditoria
                            {% if pending_approvals_count and pending_approvals_count > 0 %}
                            <span
                                style="background-color: #ef4444; color: white; border-radius: 9999px; padding: 0.125rem 0.375rem; font-size: 0.75rem; font-weight: 700; margin-left: auto;">
                                {{ pending_approvals_count }}
                            </span>
                            {% endif %}
                        </a>
                        <a href="{% url 'financial_closure_report' %}"
                            class="nav-sublink {% if 'relatorios/fechamento' in request.path %}active{% endif %}"
                            hx-boost="false"
                            style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; border-radius: 2px; color: #A3A3A3; font-weight: 500; font-size: 0.8125rem; transition: all 0.2s; margin-top: 0.25rem;">
                            <i data-lucide="pie-chart" style="width: 16px; height: 16px;"></i> Fechamento de Caixa
                        </a>
                    </div>
                </div>
                {% endif %}

            </nav>

            <div class="sidebar-footer" style="padding: 1rem; border-top: 1px solid var(--sidebar-border);">
                <form action="{% url 'logout' %}" method="post" hx-boost="false">
                    {% csrf_token %}
                    <button type="submit" class="nav-link"
                        style="background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                        <i data-lucide="log-out"></i> Sair
                    </button>
                </form>
            </div>
        </aside>
        {% endif %}

        <!-- Main Content -->
        <main class="main-content">
            {% if user.is_authenticated %}
            <div class="top-bar" id="top-bar">
                <div class="breadcrumbs">
                    {% block breadcrumbs %}
                    <span style="color: #a3a3a3;">Início</span>
                    {% endblock %}
                </div>
                <div class="user-menu" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="user" style="width: 16px; color: var(--primary);"></i>
                    <span style="font-weight: 600; color: #4B3621;">{{ user.email }}</span>
                </div>
            </div>
            {% endif %}

            <div class="content-area" id="content-area" hx-boost="true" hx-target="this" hx-swap="innerHTML">
                {% if messages %}
                <div style="margin-bottom: 1.5rem;">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}"
                        style="padding: 1rem; border-radius: 2px; margin-bottom: 0.5rem; background: {% if message.tags == 'success' %}#D1FAE5{% elif message.tags == 'error' %}#FEE2E2{% else %}#FEF3C7{% endif %}; color: {% if message.tags == 'success' %}#065F46{% elif message.tags == 'error' %}#991B1B{% else %}#92400E{% endif %}; border-left: 3px solid {% if message.tags == 'success' %}#059669{% elif message.tags == 'error' %}#DC2626{% else %}#D4AF37{% endif %};">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% block content %}
                {% endblock %}
            </div>
        </main>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Collapsible Section Logic
        function toggleSection(sectionId) {
            const submenu = document.getElementById(sectionId + '-submenu');
            const chevron = document.getElementById(sectionId + '-chevron');

            const isCollapsed = !submenu.style.maxHeight || submenu.style.maxHeight === '0px' || submenu.style.maxHeight === '0';

            if (isCollapsed) {
                submenu.style.maxHeight = submenu.scrollHeight + "px";
                if (chevron) chevron.style.transform = 'rotate(180deg)';
            } else {
                submenu.style.maxHeight = "0px";
                if (chevron) chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Auto-expand if current page is in submenu
        function updateSidebarState() {
            const activeSublink = document.querySelector('.nav-sublink.active');
            if (activeSublink) {
                const parentSubmenu = activeSublink.closest('.nav-submenu');
                if (parentSubmenu) {
                    parentSubmenu.style.maxHeight = parentSubmenu.scrollHeight + 'px';
                    const sectionId = parentSubmenu.id.replace('-submenu', '');
                    const chevron = document.getElementById(sectionId + '-chevron');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', updateSidebarState);
        document.addEventListener('htmx:afterOnLoad', updateSidebarState);
        document.addEventListener('htmx:afterSwap', function () {
            lucide.createIcons();
            // Update active classes on sidebar
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-link, .nav-sublink').forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');
                if (!href) return;
                // Exact match OR starts-with only for non-root, non-shared prefixes
                // Avoid false positives: /orders/ should not match /orders/matriz/.../
                const isExact = href === currentPath;
                // Only use startsWith if the next char after href is NOT alphanumeric (prevents /orders/ matching /orders/matriz)
                const hrefTrailingSlash = href.endsWith('/') ? href : href + '/';
                const isSubpath = href !== '/' && currentPath.startsWith(hrefTrailingSlash) && !currentPath.substring(hrefTrailingSlash.length).includes('/');
                if (isExact || isSubpath) {
                    link.classList.add('active');
                }
            });
        });

        // Progress Bar logic
        document.addEventListener('htmx:configRequest', function () {
            document.getElementById('progress-bar').style.width = '30%';
        });
        document.addEventListener('htmx:beforeSwap', function () {
            document.getElementById('progress-bar').style.width = '70%';
        });
        document.addEventListener('htmx:afterSwap', function () {
            document.getElementById('progress-bar').style.width = '100%';
            setTimeout(() => {
                document.getElementById('progress-bar').style.width = '0%';
            }, 300);
        });
    </script>
</body>

</html>